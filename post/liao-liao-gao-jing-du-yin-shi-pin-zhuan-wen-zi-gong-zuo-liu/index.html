<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>精准转写：利用 Whisper 处理音视频转文字-不完全指南 - 杂谈by立行</title>
<link rel="shortcut icon" href="https://zj1123581321.com//favicon.ico">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css">
<link rel="stylesheet" href="https://zj1123581321.com//media/css/tailwind.css">
<link rel="stylesheet" href="https://zj1123581321.com//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="精准转写：利用 Whisper 处理音视频转文字-不完全指南 - 杂谈by立行 - Atom Feed" href="https://zj1123581321.com//atom.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2920695321218858"
     crossorigin="anonymous"></script>
     
    

  <meta name="description" content="背景
前阵子女朋友去读研，授课是全英的，加之又有很多专业名词，有时就会出现理解能力跟不上讲课速度的情况。
因此借助课堂回放/录音复习也变成了一项每周必做的工作，但是完全回看一个三小时长的课程显然是不现实的，所以，音视频转文字就成了必选项。
..." />
  <meta property="og:title" content="精准转写：利用 Whisper 处理音视频转文字-不完全指南 - 杂谈by立行">
  <meta property="og:description" content="背景
前阵子女朋友去读研，授课是全英的，加之又有很多专业名词，有时就会出现理解能力跟不上讲课速度的情况。
因此借助课堂回放/录音复习也变成了一项每周必做的工作，但是完全回看一个三小时长的课程显然是不现实的，所以，音视频转文字就成了必选项。
..." />
  <meta property="og:type" content="articles">
  <meta property="og:url" content="https://zj1123581321.com/post/liao-liao-gao-jing-du-yin-shi-pin-zhuan-wen-zi-gong-zuo-liu/" />
  <meta property="og:image" content="https://zj1123581321.com//post-images/liao-liao-gao-jing-du-yin-shi-pin-zhuan-wen-zi-gong-zuo-liu.jpeg">
  <meta property="og:image:height" content="630">
  <meta property="og:image:width" content="1200">
  <meta name="twitter:title" content="精准转写：利用 Whisper 处理音视频转文字-不完全指南 - 杂谈by立行">
  <meta name="twitter:description" content="背景
前阵子女朋友去读研，授课是全英的，加之又有很多专业名词，有时就会出现理解能力跟不上讲课速度的情况。
因此借助课堂回放/录音复习也变成了一项每周必做的工作，但是完全回看一个三小时长的课程显然是不现实的，所以，音视频转文字就成了必选项。
...">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="canonical" href="https://zj1123581321.com/post/liao-liao-gao-jing-du-yin-shi-pin-zhuan-wen-zi-gong-zuo-liu/">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css">
 
  

  
</head>

<body>
  <div class="antialiased flex flex-col min-h-screen" id="app">
    <a href="https://zj1123581321.com/" class="fixed top-0 left-0 mt-4 bg-black text-white dark:text-gray-700 dark:bg-yellow-50 dark:hover:bg-black dark:hover:text-white inline-flex p-2 pl-8 hover:text-gray-700 hover:bg-yellow-50 font-bold z-10 transition-fast animated fadeInLeft">
      杂谈by立行
    </a>
    <div class="max-w-4xl w-full mx-auto">
      <div class="shadow-box bg-white dark:bg-gray-600 rounded-lg pt-32 md:pt-64 px-4 md:px-8 pb-8 animated fadeIn mb-8">
        <h1 class="text-5xl font-semibold leading-normal pb-8 mb-8 border-b-8 border-gray-700">
          精准转写：利用 Whisper 处理音视频转文字-不完全指南
        </h1>
        
          <img src="https://zj1123581321.com//post-images/liao-liao-gao-jing-du-yin-shi-pin-zhuan-wen-zi-gong-zuo-liu.jpeg" alt="精准转写：利用 Whisper 处理音视频转文字-不完全指南" class="block w-full mb-8">
        
        <div class="mb-8 flex flex-wrap">
          <div class="text-gray-400 text-sm mr-4">2023-10-19 · 19 min read</div>
          
            <a href="https://zj1123581321.com/tag/fryjhqkpJ/" class="text-gray-700 text-sm border-b-2 border-dotted border-gray-200 hover:border-gray-600 transition-all duration-100 inline-flex mr-2">
              <i class="ri-hashtag"></i>
              雕虫小技
            </a>
          
            <a href="https://zj1123581321.com/tag/W1USKO4nt/" class="text-gray-700 text-sm border-b-2 border-dotted border-gray-200 hover:border-gray-600 transition-all duration-100 inline-flex mr-2">
              <i class="ri-hashtag"></i>
              杂记
            </a>
          
        </div>
        <div class="markdown mb-8" v-pre>
          <h1 id="背景">背景</h1>
<p>前阵子女朋友去读研，授课是全英的，加之又有很多专业名词，有时就会出现理解能力跟不上讲课速度的情况。</p>
<p>因此借助课堂回放/录音复习也变成了一项每周必做的工作，但是完全回看一个三小时长的课程显然是不现实的，所以，音视频转文字就成了必选项。</p>
<h1 id="方案选择">方案选择</h1>
<h2 id="商用-asr-服务大多难以实现高精度转写">商用 ASR 服务大多难以实现高精度转写</h2>
<p>我是飞书妙记的会员，所以遇到了这个需求，我马上想到先用妙记试试。</p>
<p>然而，尝试转录的结果表明，妙记在专业课程上的转录准确度相当差，无法满足通过文字转录来提高复习速度的需求。</p>
<figure data-type="image" tabindex="1"><img src="https://zj1123581321.com//post-images/image-20231015172805840.png" alt="妙记转录结果：词汇未转录、转录错误问题频发" loading="lazy"></figure>
<p>其他商用服务(如通义听悟、讯飞听见、Notta 等)的转录效果和飞书妙记差不太多，大体原因有三点：</p>
<ol>
<li>手机远距离收音比较差，音频文件质量不高。</li>
<li>一般的商业自动语音识别(ASR-Automatic Speech Recognition) 服务主要面对会议等日常场景。但若音频内容含有过多的专业词汇，此类 ASR 服务则有点力不从心了。</li>
<li>商业 ASR 服务需在速度、准确性和成本之间取得平衡，高准确度通常需要以成本变高、速度变慢作为代价。</li>
</ol>
<p>基于问题 2 和 3 ，我放弃了继续寻找其他商业 ASR 服务的想法。</p>
<h2 id="whisper-的惊艳效果">Whisper 的惊艳效果</h2>
<p>因为平时业务里我自己基于 <a href="https://platform.openai.com/docs/guides/speech-to-text">OpenAI 发布的 Whisper API</a> 写了不少工作流，所以我又试了试 Whisper(Large-v2)的转录效果。——<strong>非常惊艳</strong>，甚至连符号的写法(theta_i^t)它都转写了出来。</p>
<figure data-type="image" tabindex="2"><img src="https://zj1123581321.com//post-images/image-20231015172942167.png" alt="Whipser LargeV2 转录结果：精度高到甚至照顾到了符号写法" loading="lazy"></figure>
<p>这里简要介绍一下 <a href="https://openai.com/research/whisper">Whisper</a>，Whisper 是 OpenAI (没错，还是 chatGPT 背后的公司)在 2022 年 9 月开源的音频转文本的模型，它的转写精确度非常高。</p>
<p>但想使用 Whisper 进行转写也并非易事。它有两种实现方式：云端 Or 本地。</p>
<p>云端转写的优势在于不会受到本地机器性能的限制，且速度相对较快。但它存在两个问题：</p>
<ol>
<li>项目处理流程复杂：OpenAI 的 Whisper API 限制单次请求的音频大小为 25Mb，而一节 3h 的音频通常都会有大几十 MB。这就需要对音频先做分段处理，再请求结果，最后合并结果。如果是 mp4 文件则还需要从中抽取音频文件，这个过程里没少踩坑。</li>
<li>成本问题：OpenAI 的 Whisper 模型 1min 收费 0.006 美元，1h 的音频按照 7.3 的汇率需要收费 2.7 元。坦白讲，Whisper 的 API 价格非常便宜了，几乎只是 Google Speech2Text API 的四分之一。但是，如果我们假设有 5 门课程，每堂课长 3小时，每周有一次课，那么每个月的转写成本 = 5 x 3 x 4 x 2.7 = 162 元，这个价格还是有点肉疼。</li>
</ol>
<p>本地转写的话倒是没有上述两个问题，但本地转写的麻烦之处在于：</p>
<ol>
<li>笔记本上缺乏好的硬件：纯 CPU 模式跑 Whisper 速度非常慢，3 小时的音频可能需要<strong>十几个小时</strong>才能转写完毕。如果想用 GPU 加速，根据<a href="https://github.com/openai/whisper/discussions/5">Whisper 模型显存需求表格</a>，官方的 Whisper-large 模型需要 10G 显存，我这台核显本实在是力不从心。后续的 <a href="https://github.com/ggerganov/whisper.cpp">Whisper cpp 项目</a> 倒是大幅降低了内存需求，但这也引出了第二个问题。</li>
<li>环境部署复杂：OpenAI 开放的毕竟是项目代码，自己写代码适配的成本还是有点高。Whisper 的 GUI 客户端在 Mac 上不少(Whisper Transcription、MacWhisper..)，Windows 上也有 Buzz ，然而要找到一个支持 GPU 加速的客户端依然十分困难。</li>
</ol>
<p>且不论是云端转还是本地转，上述方案只是实现了音频转文字的过程，但却少了一个直观的用户界面，帮助我们快速通过文字理解音频内容。</p>
<p>一个理想的转文字结果页面可以借鉴妙记的设计：</p>
<ul>
<li>左侧是音视频播放，而右侧是完整的字幕方便阅读。</li>
<li>在点击字幕时，能立刻跳转到对应的音频位置进行播放。</li>
</ul>
<p>Potplayer 的字幕浏览器倒是能变相实现这个效果，但它文本一长就被截断了，也就是勉强能用的程度。</p>
<figure data-type="image" tabindex="3"><img src="https://zj1123581321.com//post-images/image-20231015184125116.png" alt="PotPlayer 自带的字幕浏览器 Alt+E" loading="lazy"></figure>
<h2 id="memo可能是目前最好用的-whisper-客户端">Memo，可能是目前最好用的 Whisper 客户端</h2>
<p>后来某天逛小众软件的时候发现了 <a href="https://memo.ac/zh/">Memo AI </a> 的内测，它的功能刚好能满足我的需求。</p>
<ul>
<li>不论 Mac 还是 Windows，调用 Whisper 都支持 GPU 加速。哪怕核显本也能有不错的速度。</li>
<li>结果页面既可以快速浏览全部转写内容，也可以点击字幕跳转播放。</li>
<li>字幕支持一键翻译，双语对照更方便。</li>
<li>进一步做了批量转写、AI 对话等功能。</li>
</ul>
<figure data-type="image" tabindex="4"><img src="https://zj1123581321.com//post-images/P1Op5XfnI9iZslz.png" alt="Memo 页面截图" loading="lazy"></figure>
<p>这可真是刚想瞌睡就有人送枕头。有了 Memo 之后，下面就可以介绍我们整个转录工作的流程了。</p>
<h1 id="操作流程">操作流程</h1>
<h2 id="音视频文件来源">音视频文件来源</h2>
<p>音视频文件主要有两种来源：学校提供的课程视频回放、手机/录音笔的录音结果。</p>
<h3 id="课程视频回放下载">课程视频回放下载</h3>
<p>某些课程在 <a href="https://www.canvaslms.net/">Canvas LMS</a> 平台上提供了视频回放的功能，但却没有视频下载的选项。</p>
<p>不过网站视频的下载也并不困难，视频是基于 m3u8 的，并且没有加密。只需要获取到 m3u8 地址，随后使用 m3u8下载器就能把视频下载到本机。</p>
<p>至于提取视频url的工具，我推荐使用 <a href="https://github.com/xifangczy/cat-catch">xifangczy/cat-catch: 猫抓 chrome资源嗅探扩展</a>。通过使用“猫抓”，可解决大约 80% 的网页视频下载问题。</p>
<p>m3u8 下载器则推荐 <a href="https://github.com/nilaoda/N_m3u8DL-CLI">N_m3u8DL-CLI</a>，一键搞定。</p>
<h3 id="录音">录音</h3>
<p>没有提供视频回放的课程只能通过自己录音来解决。设备不外乎两种：手机或者录音笔。</p>
<p>至于具体选什么设备，这里得根据自己的情况来确定。</p>
<p>通常，手机的远距离收音效果比较一般。在课堂这样的场合，如果不能坐在前排，老师的声音往往会被其他噪音掩盖。</p>
<p>录音笔的效果通常会比手机更好，一般 100-200 元的价格就可以满足需求。</p>
<p>如果是部分留学&amp;专业课程场景，<strong>不建议为了实时语音转文字功能而选择某些录音笔</strong>，可能会有三个比较大的问题：</p>
<ol>
<li>实时转写准确度很差：从理论上讲，实时转写的难度更大，而非实时的商用 ASR 服务转写的准确度已经是那个德性了，那么在专业课场景下，实时转写几乎毫无用处。</li>
<li>人在境外可能会有网络问题：实时转写实际上是把录到的音频发送到制造商的服务器，服务器再把转译结果发送回来。但很多厂家的服务器都在国内，如果人在国外，可能经常会遇到网络中断的问题。</li>
<li>App 的维护差：目前，主打免费实时语音转文字的录音笔通常都配有相应的客户端，但这些客户端的长期稳定性很难让人放心。像讯飞的录音笔就硬生生地拆出了三个独立的手机应用(极智、听见、语记)，不同的录音笔只能连接特定的应用，而有的应用在 iOS 上已经下架一年多了。。</li>
</ol>
<h2 id="文件前置处理可选">文件前置处理(可选)</h2>
<h3 id="降噪响度均衡人声增强">降噪&amp;响度均衡&amp;人声增强</h3>
<p>有时, 录音效果可能比较尴尬。这可能是由于手机的收音能力较弱，或者是录音位置与声源之间的距离过大。这种情况下，我们可能会遇到以下问题：</p>
<ul>
<li>在录音中，目标声源的音量过小，以至于无法听清楚。</li>
<li>录音中存在大量噪声。</li>
<li>录音中前后两部分的声音音量存在很大差异，导致播放时声音大小起伏不定。</li>
</ul>
<p>因此，在进行转录前，最好先对音频进行一些处理，这可以有效提升 Whisper 转录的效果。我主要做三个操作：人声增强、降噪、响度均衡。</p>
<p>具体的软件在 Windows 上我使用 Pr，在 Mac 上我使用 Final Cut Pro。</p>
<figure data-type="image" tabindex="5"><img src="https://zj1123581321.com//post-images/image-20231015205318025.png" alt="Pr2020，选项和数值仅供参考。" loading="lazy"></figure>
<figure data-type="image" tabindex="6"><img src="https://zj1123581321.com//post-images/image-20231015205512123.png" alt="Final Cut Pro, 选项和数值仅供参考。" loading="lazy"></figure>
<h3 id="去除大段空白">去除大段空白</h3>
<p>下载的课程回放视频通常都包含 20 至 30 分钟的课间休息时间，我通常会选择把这部分片段从视频里切掉。这么做有两个目的：</p>
<ol>
<li>
<p>减小文件体积：一个 3 小时的回放视频大约占据 1.5G 的空间，移除 30 分钟的视频可以节省约 200M 的存储空间。</p>
</li>
<li>
<p>降低 Whisper 出现幻觉的可能：虽然 Whisper 的转写精度相当高，但它偶尔也会出现幻觉——即从某一时间点开始，转录文本会不断重复某句话。而大量的空白时间可能会触发这种幻觉。</p>
<p>手动删除空白时间段内容是一种很糙的解决方案，更优雅的方案是结合声音活动检测(VAD, Voice Activity Detection) 来做转写，自动忽略掉空白时间段。(开发者说 Memo 的后续版本会接入 VAD)</p>
</li>
</ol>
<p>至于切视频，可以使用 Pr/FCP 等剪辑软件，但这种方式需要重新编码处理后的视频，比较耗时间。愿意折腾一下的话此处建议使用 ffmpeg 通过复制流的方式来做，通常 3 小时的视频文件切掉空白只需几秒钟。</p>
<p>核心的命令为两个：</p>
<p><strong>从视频里提取特定时间段</strong></p>
<pre><code>$$ffmpeg -i &quot;{OriFileLoc}&quot; -ss {RangeTimeStart} -to {RangeTimeEnd} -c:v copy -c:a copy &quot;{OriFileParDir}\temp\temp_video_{temp_video_index}{OriFileExtension}&quot;
</code></pre>
<p><strong>利用 concat 衔接多个视频(格式一致)</strong></p>
<pre><code>$$ffmpeg -y -hide_banner -vsync 0 -safe 0 -f concat -i &quot;{OriFileParDir}\temp\fileList.txt&quot; -c copy &quot;{OriFileParDir}\RmBlank_{OriFileName}{OriFileExtension}&quot;
</code></pre>
<p>你可以把本地文件地址丢给 chatGPT 让他直接给你生成最终的命令，抑或使用 <a href="https://github.com/HaujetZhao/QuickCut">QuickCut: Your most handy video processing software</a> 或者我编写的 <a href="https://getquicker.net/Sharedaction?code=1783e573-f3af-49b8-127a-08dbbe5b3358">Quicker 动作</a>。</p>
<h2 id="确定-prompt">确定 Prompt</h2>
<figure data-type="image" tabindex="7"><img src="https://zj1123581321.com//post-images/image-20231015211743520.png" alt="Memo 里 Whisper 的转写选项" loading="lazy"></figure>
<h3 id="whisper-的-prompt-和-chatgpt-的-prompt-是两种东西">Whisper 的 Prompt 和 chatGPT 的 Prompt 是两种东西</h3>
<p>与传统的 ASR 模型不同，Whisper <strong>在某些情况下</strong>可以借助 Prompt 提升音频转文字的准确度。</p>
<p>虽然同属于 OpenAI，但 Whisper 和 chatGPT 的 Prompt 差别非常大。</p>
<p>如果 Whisper 的 Prompt 是 &quot;请尽力保持每句话的完整 并给每句话都添加标点符号&quot;，你会发现这句 Prompt 没有任何作用，Whisper 的转录结果里可能还是会出现大量中断的句子，或者转录结果无标点。</p>
<p><strong>这是因为 Whisper 是在尝试学习 Prompt 里的“风格(style)”，而非具体的指令。</strong></p>
<p>那什么是 Prompt 的“风格”？</p>
<p>根据 Whisper 的 <a href="https://github.com/openai/openai-cookbook/blob/main/examples/Whisper_prompting_guide.ipynb">cookbook</a>、 <a href="https://github.com/openai/whisper/discussions?discussions_q=prompt">Whisper prompt 的 issues</a> 和我的实际体验，Prompt 的风格可以表现在下面几个方面：</p>
<h4 id="风格-1prompt-里是否包含标点符号">风格 1：Prompt 里是否包含标点符号。</h4>
<p>Whisper 的转录结果有时会缺乏标点符号，这个时候你可以使用带标点符号的 Prompt 的来引导 Whisper 添加标点。</p>
<ol>
<li>“生于忧患，死于安乐。岂不快哉？”</li>
<li>“请为转写的文本添加标点符号”</li>
</ol>
<p>Prompt 1 是有意义的，Prompt 2 是无意义的。</p>
<p>不过 Whisper 也不是能每一次都学会 Prompt 的风格添加标点符号。实测在 Whisper-large v2 模型下，通常英文内容使用 prompt 可以为结果添加标点，中文内容则要看运气。</p>
<h4 id="风格2一些容易拼写错误的人名-产品名-公司名">风格2：一些容易拼写错误的人名、产品名、公司名</h4>
<p>这里比较好理解，不同的词汇可能会有同一个发音。你可以在 Prompt 里指定你希望的拼写格式。</p>
<p>比如一段对话里提到了张三和李四，而“张三”的音同“章三”、“樟叁”...</p>
<p>那 Prompt 里就可以包含 “张三，李四。”</p>
<h4 id="风格3是否包含一些填充词filler-words">风格3：是否包含一些填充词(filler words)</h4>
<p>这里直接引用官方的说法来解释，翻译成中文会有点怪异。</p>
<blockquote>
<p>The model may also leave out common filler words in the audio. If you want to keep the filler words in your transcript, you can use a prompt that contains them: &quot;Umm, let me think like, hmm... Okay, here's what I'm, like, thinking.&quot;</p>
</blockquote>
<h4 id="风格4简体中文和繁体中文">风格4：简体中文和繁体中文</h4>
<p>因为中文有两种，有的时候 Whisper 会把音频以繁体中文的形式转录。此时用简体中文来陈述 Prompt 大概率可以解决此问题。</p>
<p>一般建议 Whisper 的 Prompt 语言和转录的音频语言一致。即英文音频用英语 Prompt，中文音频用简中/繁中 Prompt。</p>
<h4 id="风格5通过对话风格的-prompt-变相实现转录结果区分说话人">风格5：通过对话风格的 Prompt 变相实现转录结果区分说话人</h4>
<p>这个技巧来自于 <a href="https://github.com/openai/whisper/discussions/117">prompt vs prefix in DecodingOptions </a>，有的时候会有效果。</p>
<p>单纯的 Whisper 模型并不能在转录结果里区分出说话人，想要区分说话人，一般会配合 Pyannote 来做。但在某些场景下，我们可以通过 Prompt 来变相实现区分说话人——<strong>每一句的转录结果都属于单个说话人</strong>，不会出现某一句的转录结果属于多个说话人的情况。</p>
<p>方法就是用一个对话式的 Prompt：</p>
<ul>
<li>“- How are you? - I'm fine, thank you.”</li>
<li>“- 吃了没？- 吃了。”</li>
</ul>
<p>播客这种场景可以试试。</p>
<h4 id="whisper-prompt-的其他-tips">Whisper Prompt 的其他  Tips</h4>
<ul>
<li>
<p>Whisper 的 Prompt 应该尽可能长一些，太短的 prompt 的风格难以学习。</p>
</li>
<li>
<p>Whisper 的 Prompt 只会使用 224 个 token，如果超过 224 个 token 则会默认使用最后 224 个 token。token 的概念可以参考<a href="https://zhuanlan.zhihu.com/p/618029100">这篇文章</a>，但 Memo 的 Prompt 直接限制了字符串长度，这里就不用在乎 token 长度了，只需要尽量让自己的 prompt 完整输入到 Memo 输入框里就行。</p>
</li>
<li>
<p>Whisper 的 Prompt 最好和音频的源语言一致。</p>
</li>
</ul>
<h3 id="怎样快速生成-prompt">怎样快速生成 Prompt？</h3>
<p>因为我主要转录的是课程内容，所以我的 Whisper Prompt 通常会使用这节课的关键词列表。如果课程有讲义 pdf 文件，我会直接把它丢给 <a href="https://claude.ai">Claude</a>，然后：</p>
<pre><code>summarize the file, response me with format like :&quot;keyword1, keyword2, keyword3,keyword4..&quot;
</code></pre>
<p>如果课程没有讲义，我会手动输入几个关键词，或者直接从课本里随便挑一段话作为 prompt。</p>
<h2 id="转写">转写</h2>
<h3 id="模型选择">模型选择</h3>
<p>Whisper 转写需要指定模型。模型越大，转写越精准，转写速度越慢。</p>
<figure data-type="image" tabindex="8"><img src="https://zj1123581321.com//post-images/image-20231015230928775.png" alt="Whisper 模型与说明" loading="lazy"></figure>
<h3 id="gpu-加速">GPU 加速</h3>
<p>Memo 在 Windows 和 Mac 上都实现了 GPU 加速。</p>
<h4 id="windows">Windows</h4>
<p>Windows 电脑如果是独显机器大部分应该没什么问题，部分显卡的测试转录速度如下：</p>
<blockquote>
<ul>
<li>RTX4090 显卡在 Large 模型下转录 1.2 小时音频时间为 7 分钟</li>
<li>RTX3080Ti 显卡在 Large 模型下转录 1.2 小时音频时间为 8 分钟</li>
<li>RTX3080Ti 显卡在 Large 模型下转录 0.4 小时日漫时间为 2 分钟</li>
<li>RTX3060 laptop 显卡在 Large 模型下转录 1.2 小时音频时间为 20 分钟</li>
<li>RTX3060 在 Large 模型下转录 1.2 小时音频时间为 12 分钟</li>
<li>6600XT 显卡在 Large 模型下转录 1.2 小时音频时间为 11 分钟</li>
<li>5700XT 显卡在 Large 模型下转录 1.2 小时音频时间为 15 分钟</li>
</ul>
</blockquote>
<p>如果你的电脑只有核显，那可能会遇到显存不足的问题。</p>
<p>但这里如果是 AMD 的核显，你可以尝试在 Bios 里调整显存大小。(高风险行为，谨慎操作)</p>
<p><a href="https://www.bilibili.com/video/BV1UV4y1c7br/?spm_id_from=333.880.my_history.page.click&amp;vd_source=c2b8be35c825954dae60fa802e7dba82">游戏爆显存？显示器黑屏花屏？BIOS没有调整选项？AMD核显显存大小调整教程（UniversalAMDFormBrowser</a><br>
<a href="https://www.bilibili.com/video/BV1w84y167ep/?spm_id_from=333.880.my_history.page.click&amp;vd_source=c2b8be35c825954dae60fa802e7dba82">AMD台式及笔记本改核显显存教程，核显还只有512M？</a></p>
<p>我手里的笔记本是 R7-6800H，32G 内存，出厂分配 4G 作为 GPU 显存。在 Large 模型下，开启 GPU 加速后显存会占满，转录时长：音频时长大概等于 1:2 。</p>
<p>我尝试把显存开到 8G，跑 Whisper 时大概会占用 6G 显存，但速度相较于 4G 显存无提升。所以如果调整 Bios 的显存大小，通常调整到 4G 就足够使用了。</p>
<h4 id="mac">Mac</h4>
<p>Intel 的机器我手上没有，主要分享一下 M 系列的机器速度。</p>
<p>M 系列的 GPU 加速倍数近似和 GPU 核心数成正比：</p>
<ul>
<li>M1 Max 32 gpu core ，转录时长：音频时长 = 1：12</li>
<li>M2 Pro 16 gpu core，转录时长：音频时长 = 1：6</li>
</ul>
<p>Mac GPU 核心数对比可参考 <a href="https://www.macworld.com/article/670873/which-mac-processor-apple-processor-comparison-m1-vs-intel.html">Mac processor comparison: M1 &amp; M2 vs Intel | Macworld</a>。</p>
<p>使用 Whisper GPU 加速时，除了消耗 GPU，同时也会消耗大量内存。我用 Large 模型时 Memo 占用 6.4 G 内存。</p>
<figure data-type="image" tabindex="9"><img src="https://zj1123581321.com//post-images/image-20231015232947090.png" alt="Whisper Large GPU 加速时内存占用 6.4G" loading="lazy"></figure>
<h2 id="转写结果优化处理">转写结果优化处理</h2>
<figure data-type="image" tabindex="10"><img src="https://zj1123581321.com//post-images/image-20231016001016709.png" alt="Whisper 原始转录结果" loading="lazy"></figure>
<p>如果是在为视频创建简易的字幕文件，那到这里基本可以收工了。但如果是在为需要快速阅读全文的课程或会议等场景进行操作，那么此处可以对转写结果做一些优化，主要解决两个问题：</p>
<ol>
<li>有的句子被拆分成了两行，调用翻译的时候不方便。(比如 00:15-00:19)</li>
<li>每行的字数太短，读起来很累。最好是有个段落模式，每个时间点的内容多一些。</li>
</ol>
<p>开发者说这两个功能未来的版本都会实现，但在没实现之前只能靠我们自己来处理了。我写了一段 Python 的脚本将原始的字幕转换成段落模式的字幕：<a href="https://github.com/zj1123581321/Adjust_SubTitle">Adjust_SubTitle: 调节 Whisper 转录生成的 srt 文件，避免一句话被分成两行，避免一句话过短。</a></p>
<p>你可以导出原始转录的 srt 文件，然后修改 AdjustSrt.py 里的 srt 文件路径，运行脚本后会自动在原始路径下生成段落模式的 srt 的字幕。最后只需重新创建 Memo 任务，同时指定需导入的音频和字幕文件即可。</p>
<figure data-type="image" tabindex="11"><img src="https://zj1123581321.com//post-images/image-20231016002138481.png" alt="合并句子成段落" loading="lazy"></figure>
<p>因为段落模式的实现逻辑是基于原始转录结果里的标点符号，所以运行脚本的前置条件是 <strong>Whisper 生成的字幕里有标点</strong>。</p>
<p>除此之外，基于标点符号的段落模式<strong>只能用于只有一个说话人的情况</strong>。否则可能会导致一句话里出现了多个说话人，容易造成误解。</p>
<h1 id="潜在问题与更多场景">潜在问题与更多场景</h1>
<h2 id="whisper-的不足">Whisper 的不足</h2>
<p>虽然 Whisper 结合上下文的能力很强，转写准确度非常高。但 Whisper 也有两个比较麻烦的问题：</p>
<h3 id="令人头疼的幻觉问题">令人头疼的幻觉问题</h3>
<p>所谓“幻觉”是指 Whisper 转录的文本和音频不相关，而是在不断重复之前的转录结果。</p>
<figure data-type="image" tabindex="12"><img src="https://zj1123581321.com//post-images/image-20231016003953822.png" alt="Whisper 幻觉：重复某一句话" loading="lazy"></figure>
<p>我体验下来目前主要是两种情况会造成幻觉：</p>
<ol>
<li>大段的空白内容。</li>
<li>低录音质量，有比较大的噪音。</li>
</ol>
<p>1 比较好处理，Memo 之后会引入 VAD 自动过滤空白内容。</p>
<p>同时根据 <a href="https://github.com/openai/whisper/pull/1253">Ignore repeated prompt by heimoshuiyu · Pull Request #1253 · openai/whisper</a> 这个 issue，设定 <code>--condition_on_previous_text False</code> ，也就是不让 Whisper 用前文的转写结果转录后面的音频，也能降低空白引起幻觉的概率，但代价是丧失了 Whisper 在上下文理解上的优势。(<a href="https://github.com/Makememo/MemoAI/issues/23">开发者说后续会开放此参数</a>。)</p>
<p>但 2 目前还没找到比较好的解决方案，只能是再尝试对音频调整降噪、人声增强的强度试试..</p>
<h3 id="薛定谔的标点符号">薛定谔的标点符号</h3>
<p>从天梯榜上看，Whisper 的英语转录效果名列前茅，而对于中文的转录效果在中等水平。</p>
<p>上文提到过，如果是英文音频，那合适的 Prompt 大概率可以给转写结果添加标点，但中文音频则有概率无法添加标点。此时就比较尴尬了，我也没有找到比较好的解决方案，如果有朋友知道怎么解决，欢迎评论区里分享。</p>
<p>我曾经尝试利用 gpt 3.5 来给生成的文本添加标点符号，但由于 gpt 也存在幻觉，它经常直接将文本合并，然后时间戳和文本就对不上了。。如果用 4 的话成本则有点高。</p>
<figure data-type="image" tabindex="13"><img src="https://raw.githubusercontent.com/openai/whisper/main/language-breakdown.svg" alt="Whisper 在不同语言的转写效果，数值越低越好。" loading="lazy"></figure>
<h2 id="适合使用-whisper-的人群">适合使用 Whisper 的人群</h2>
<ul>
<li>对音频转文字有强需求，同时愿意用更长的时间换更高的转写精度。</li>
<li>对隐私敏感，音频不能传到互联网的场景。</li>
<li>手里有不错的电脑设备(16G 内存+，能开启 GPU 加速)。</li>
</ul>
<hr>
<p>希望这篇分享对你有所帮助，以上。</p>
<hr>
<p>同步首发于 <a href="https://sspai.com/post/83644">精准转写：利用 Whisper 处理音视频转文字不完全指南 - 少数派</a>，沟通交流可以移步少数派方便点。</p>

        </div>
        <!-- Share to Twitter, Weibo, Telegram -->
        <div class="flex items-center">
          <div class="mr-4 flex items-center">
            <i class="ri-share-forward-line text-gray-500"></i>
          </div>
          <div class="px-4 cursor-pointer text-blue-500 hover:bg-blue-100 dark:hover:bg-gray-600 inline-flex" @click="shareToTwitter">
            <i class="ri-twitter-line"></i>
          </div>
          <div class="px-4 cursor-pointer text-red-500 hover:bg-red-100 dark:hover:bg-gray-600 inline-flex" @click="shareToWeibo">
            <i class="ri-weibo-line"></i>
          </div>
          <div class="px-4 cursor-pointer text-indigo-500 hover:bg-indigo-100 dark:hover:bg-gray-600 inline-flex" @click="shareToTelegram">
            <i class="ri-telegram-line"></i>
          </div>
        </div>
      </div>

      

      
        <div id="vlaine-comment"></div>
      

      <footer class="py-12 text-center px-4 md:px-0" v-pre>
  <a href="https://google.com" target="_blank">
一切随缘</a>
</footer>
    </div>

    <!-- TOC Container -->
    <div class="fixed right-0 bottom-0 mb-16 mr-4 shadow w-8 h-8 rounded-full flex justify-center items-center z-10 cursor-pointer bg-white dark:bg-gray-500 dark:text-gray-200 hover:shadow-lg transition-all animated fadeInRight" @click="showToc = true">
      <i class="ri-file-list-line"></i>
    </div>

    <div class="fixed right-0 top-0 bottom-0 overflow-y-auto w-64 bg-white dark:bg-gray-800 p-4 border-l border-gray-100 dark:border-gray-600 z-10 transition-fast" :class="{ '-mr-64': !showToc }">
      <div class="flex mb-4 justify-end">
        <div class="w-8 h-8 inline-flex justify-center items-center rounded-full cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-fast" @click="showToc = false">
          <i class="ri-close-line text-lg"></i>
        </div>
      </div>
      <div class="post-toc-container">
        <ul class="markdownIt-TOC">
<li><a href="#%E8%83%8C%E6%99%AF">背景</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9">方案选择</a>
<ul>
<li><a href="#%E5%95%86%E7%94%A8-asr-%E6%9C%8D%E5%8A%A1%E5%A4%A7%E5%A4%9A%E9%9A%BE%E4%BB%A5%E5%AE%9E%E7%8E%B0%E9%AB%98%E7%B2%BE%E5%BA%A6%E8%BD%AC%E5%86%99">商用 ASR 服务大多难以实现高精度转写</a></li>
<li><a href="#whisper-%E7%9A%84%E6%83%8A%E8%89%B3%E6%95%88%E6%9E%9C">Whisper 的惊艳效果</a></li>
<li><a href="#memo%E5%8F%AF%E8%83%BD%E6%98%AF%E7%9B%AE%E5%89%8D%E6%9C%80%E5%A5%BD%E7%94%A8%E7%9A%84-whisper-%E5%AE%A2%E6%88%B7%E7%AB%AF">Memo，可能是目前最好用的 Whisper 客户端</a></li>
</ul>
</li>
<li><a href="#%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B">操作流程</a>
<ul>
<li><a href="#%E9%9F%B3%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E6%9D%A5%E6%BA%90">音视频文件来源</a>
<ul>
<li><a href="#%E8%AF%BE%E7%A8%8B%E8%A7%86%E9%A2%91%E5%9B%9E%E6%94%BE%E4%B8%8B%E8%BD%BD">课程视频回放下载</a></li>
<li><a href="#%E5%BD%95%E9%9F%B3">录音</a></li>
</ul>
</li>
<li><a href="#%E6%96%87%E4%BB%B6%E5%89%8D%E7%BD%AE%E5%A4%84%E7%90%86%E5%8F%AF%E9%80%89">文件前置处理(可选)</a>
<ul>
<li><a href="#%E9%99%8D%E5%99%AA%E5%93%8D%E5%BA%A6%E5%9D%87%E8%A1%A1%E4%BA%BA%E5%A3%B0%E5%A2%9E%E5%BC%BA">降噪&amp;响度均衡&amp;人声增强</a></li>
<li><a href="#%E5%8E%BB%E9%99%A4%E5%A4%A7%E6%AE%B5%E7%A9%BA%E7%99%BD">去除大段空白</a></li>
</ul>
</li>
<li><a href="#%E7%A1%AE%E5%AE%9A-prompt">确定 Prompt</a>
<ul>
<li><a href="#whisper-%E7%9A%84-prompt-%E5%92%8C-chatgpt-%E7%9A%84-prompt-%E6%98%AF%E4%B8%A4%E7%A7%8D%E4%B8%9C%E8%A5%BF">Whisper 的 Prompt 和 chatGPT 的 Prompt 是两种东西</a>
<ul>
<li><a href="#%E9%A3%8E%E6%A0%BC-1prompt-%E9%87%8C%E6%98%AF%E5%90%A6%E5%8C%85%E5%90%AB%E6%A0%87%E7%82%B9%E7%AC%A6%E5%8F%B7">风格 1：Prompt 里是否包含标点符号。</a></li>
<li><a href="#%E9%A3%8E%E6%A0%BC2%E4%B8%80%E4%BA%9B%E5%AE%B9%E6%98%93%E6%8B%BC%E5%86%99%E9%94%99%E8%AF%AF%E7%9A%84%E4%BA%BA%E5%90%8D-%E4%BA%A7%E5%93%81%E5%90%8D-%E5%85%AC%E5%8F%B8%E5%90%8D">风格2：一些容易拼写错误的人名、产品名、公司名</a></li>
<li><a href="#%E9%A3%8E%E6%A0%BC3%E6%98%AF%E5%90%A6%E5%8C%85%E5%90%AB%E4%B8%80%E4%BA%9B%E5%A1%AB%E5%85%85%E8%AF%8Dfiller-words">风格3：是否包含一些填充词(filler words)</a></li>
<li><a href="#%E9%A3%8E%E6%A0%BC4%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87%E5%92%8C%E7%B9%81%E4%BD%93%E4%B8%AD%E6%96%87">风格4：简体中文和繁体中文</a></li>
<li><a href="#%E9%A3%8E%E6%A0%BC5%E9%80%9A%E8%BF%87%E5%AF%B9%E8%AF%9D%E9%A3%8E%E6%A0%BC%E7%9A%84-prompt-%E5%8F%98%E7%9B%B8%E5%AE%9E%E7%8E%B0%E8%BD%AC%E5%BD%95%E7%BB%93%E6%9E%9C%E5%8C%BA%E5%88%86%E8%AF%B4%E8%AF%9D%E4%BA%BA">风格5：通过对话风格的 Prompt 变相实现转录结果区分说话人</a></li>
<li><a href="#whisper-prompt-%E7%9A%84%E5%85%B6%E4%BB%96-tips">Whisper Prompt 的其他  Tips</a></li>
</ul>
</li>
<li><a href="#%E6%80%8E%E6%A0%B7%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90-prompt">怎样快速生成 Prompt？</a></li>
</ul>
</li>
<li><a href="#%E8%BD%AC%E5%86%99">转写</a>
<ul>
<li><a href="#%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9">模型选择</a></li>
<li><a href="#gpu-%E5%8A%A0%E9%80%9F">GPU 加速</a>
<ul>
<li><a href="#windows">Windows</a></li>
<li><a href="#mac">Mac</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E8%BD%AC%E5%86%99%E7%BB%93%E6%9E%9C%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86">转写结果优化处理</a></li>
</ul>
</li>
<li><a href="#%E6%BD%9C%E5%9C%A8%E9%97%AE%E9%A2%98%E4%B8%8E%E6%9B%B4%E5%A4%9A%E5%9C%BA%E6%99%AF">潜在问题与更多场景</a>
<ul>
<li><a href="#whisper-%E7%9A%84%E4%B8%8D%E8%B6%B3">Whisper 的不足</a>
<ul>
<li><a href="#%E4%BB%A4%E4%BA%BA%E5%A4%B4%E7%96%BC%E7%9A%84%E5%B9%BB%E8%A7%89%E9%97%AE%E9%A2%98">令人头疼的幻觉问题</a></li>
<li><a href="#%E8%96%9B%E5%AE%9A%E8%B0%94%E7%9A%84%E6%A0%87%E7%82%B9%E7%AC%A6%E5%8F%B7">薛定谔的标点符号</a></li>
</ul>
</li>
<li><a href="#%E9%80%82%E5%90%88%E4%BD%BF%E7%94%A8-whisper-%E7%9A%84%E4%BA%BA%E7%BE%A4">适合使用 Whisper 的人群</a></li>
</ul>
</li>
</ul>

      </div>
    </div>

    <!-- Back to top -->
    <div class="fixed right-0 bottom-0 mb-4 mr-4 shadow w-8 h-8 rounded-full flex justify-center items-center z-10 cursor-pointer bg-white hover:shadow-lg transition-all dark:bg-gray-500 dark:text-gray-200" @click="backToUp" v-show="scrolled">
      <i class="ri-arrow-up-line"></i>
    </div>
  </div>

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <!-- Background of PhotoSwipe. 
        It's a separate element as animating opacity is faster than rgba(). -->
  <div class="pswp__bg">
  </div>
  <!-- Slides wrapper with overflow:hidden. -->
  <div class="pswp__scroll-wrap">
    <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
    <div class="pswp__container">
      <div class="pswp__item">
      </div>
      <div class="pswp__item">
      </div>
      <div class="pswp__item">
      </div>
    </div>
    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <!--  Controls are self-explanatory. Order can be changed. -->
        <div class="pswp__counter">
        </div>
        <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
        <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
        <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
        <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
        <!-- element will get class pswp__preloader--active when preloader is running -->
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip">
        </div>
      </div>
      <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
      </button>
      <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
      </button>
      <div class="pswp__caption">
        <div class="pswp__caption__center">
        </div>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://zj1123581321.com//media/scripts/main.js"></script>
  
  <!-- Code Highlight -->
  

  <script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>
  <script>
    //拿到预览框架，也就是上面的html代码
    var pswpElement = document.querySelectorAll('.pswp')[0];
    //定义图片数组变量
    var imgitems;
    /**
    * 用于显示预览界面
    * @param index 图片数组下标
    */
    function viewImg(index) {
      //其它选项这里不做过多阐述，详情见官网
      var pswpoptions = {
        index: parseInt(index, 10), // 开始幻灯片索引。0是第一张幻灯片。必须是整数，而不是字符串。
        bgOpacity: 0.7, // 背景透明度，0-1
        maxSpreadZoom: 3, // 缩放级别，不要太大
      };
      //初始化并打开PhotoSwipe，pswpElement对应上面预览框架，PhotoSwipeUI_Default为皮肤，imgitems为图片数组，pswpoptions为选项
      var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, imgitems, pswpoptions);
      gallery.init()
    }
    /**
    * 用于添加图片点击事件
    * @param img 图片元素
    * @param index 所属下标（在imgitems中的位置）
    */
    function addImgClick(img, index) {
      img.onclick = function() {
        viewImg(index)
      }
    }
    /**
    * 轮询所有图片，获取src、width、height等数据，加入imgitems，并给图片元素添加事件
    * 最好在onload中执行该方法，本站因放在最底部，所以直接初始化
    * 异步加载图片可在图片元素创建完成后调用此方法
    */
    function initImg() {
      //重置图片数组
      imgitems = [];
      //查找class:markdown 下的所有img元素并遍历
      var imgs = document.querySelectorAll('.markdown img');
      for (var i = 0; i < imgs.length; i++) {
        var img = imgs[i];
        //本站相册初始为loading图片，真实图片放在data-src
        var ds = img.getAttribute("data-src");
        //创建image对象，用于获取图片宽高
        var imgtemp = new Image();
        //判断是否存在data-src
        if (ds != null && ds.length > 0) {
          imgtemp.src = ds
        } else {
          imgtemp.src = img.src
        }
        //判断是否存在缓存
        if (imgtemp.complete) {
          var imgobj = {
            "src": imgtemp.src,
            "w": imgtemp.width,
            "h": imgtemp.height,
          };
          imgitems[i] = imgobj;
          addImgClick(img, i);
        } else {
          console.log('进来了2')
          imgtemp.index = i;
          imgtemp.img = img;
          imgtemp.onload = function() {
            var imgobj = {
              "src": this.src,
              "w": this.width,
              "h": this.height,
            };
            //不要使用push，因为onload前后顺序会不同
            imgitems[this.index] = imgobj
            //添加点击事件
            addImgClick(this.img, this.index);
          }
        }
      }
    }
    //初始化
    initImg();
  </script>
  
    <script type="application/javascript" src="https://unpkg.com/valine"></script>
<script type="application/javascript">
  new Valine({
    el: '#vlaine-comment',
    appId: 'jpU4bE7syE3UkpRXTWkX6c8s-gzGzoHsz',
    appKey: '1PjXPXbbnlwTUHwHqwXtnmpJ',
    pageSize: '10',
    avatar: 'mp',
    placeholder: '评论请点我：)',
    visitor: 'false',
    highlight: 'false',
    recordIP: 'true'
  })
</script>
  
  
</body>

</html>